---
title: "Session contracts"
description: "SessionService lifecycle, concurrency, durability, and realm-scoped guarantees."
icon: "file-lines"
---

## SessionService lifecycle

All surfaces (CLI, REST, JSON-RPC, MCP server) route through `SessionService`.

```text
CLI ----------+
REST ---------+
MCP Server ---+---> SessionService ---> AgentFactory::build_agent()
JSON-RPC -----+
```

## Agent construction contract

Agent construction is centralized in `AgentFactory::build_agent()`.

- Surfaces pass per-request build data in-band via `CreateSessionRequest.build` (`SessionBuildOptions`).
- No out-of-band staging lock is used.
- `FactoryAgentBuilder` maps `SessionBuildOptions` to `AgentBuildConfig`.
- Session metadata persists realm context: `realm_id`, `instance_id`, `backend`, `config_generation`.

## Session operations

### create_session

`create_session(req)` builds the agent and runs first turn.

- Returns `RunResult` with `session_id`.
- Supports host mode where enabled.

### start_turn

`start_turn(id, req)` executes a new turn on an existing session.

- At most one in-flight turn per session.
- Concurrent attempts return `SESSION_BUSY`.

### interrupt

`interrupt(id)` cancels in-flight turn.

- If no turn is running: `SESSION_NOT_RUNNING`.

### read and list

- `read(id)` and `list(query)` are non-blocking with respect to in-flight turns.
- Persistent services can include durable sessions from the realm backend.

### archive

- Removes session from live runtime.
- Persistent behavior depends on service/store implementation.

## Realm contract

Sessions are realm-scoped.

- Same `realm_id`: shared visibility and config context.
- Different `realm_id`: strict isolation.
- Backend is pinned per realm via `realm_manifest.json`.

## Compaction contract

Compaction is optional and non-fatal.

- Triggered by token thresholds and turn guards.
- On failure, emits `CompactionFailed` and continues with uncompacted history.
- Compaction usage counts toward run budgets.

## Durability

### Ephemeral mode

No durability across process restart.

### Persistent mode

Durability follows the active realm backend (`redb` or `jsonl`).

- Completed turns are persisted.
- Crash during in-flight turn may lose only that turn.

## Config concurrency contract

Config runtime uses generation CAS.

- `config/get` returns current `generation`.
- `config/set` and `config/patch` can specify `expected_generation`.
- Mismatches fail deterministically with generation conflict.

## Data governance

<Warning>
No automatic sensitive-data redaction is applied to session content or tool payloads.
Encrypt storage at rest externally if required by your environment.
</Warning>

## See also

- [Realms](/concepts/realms)
- [Sessions](/concepts/sessions)
- [Capability matrix](/reference/capability-matrix)
