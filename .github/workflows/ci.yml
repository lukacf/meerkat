name: CI

on:
  push:
    branches:
      - main
      - ci/**
      - feat/**
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt-lint:
    name: Format, lint, and static checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: make fmt-check

      - name: Legacy surface gate
        run: make legacy-surface-gate

      - name: Verify version parity
        run: make verify-version-parity

      - name: Clippy (all features)
        run: make lint

      - name: Clippy feature matrix
        run: make lint-feature-matrix

      - name: Install cargo-machete
        uses: taiki-e/install-action@cargo-machete

      - name: Check for unused dependencies
        run: cargo machete --with-metadata

  test:
    name: Test suite (all features)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: Swatinem/rust-cache@v2

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Full test suite (all features)
        run: cargo nextest run --workspace --all-features

  test-minimal:
    name: Minimal feature builds
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: minimal

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Minimal build checks
        run: |
          cargo check -p meerkat-core
          cargo check -p meerkat-client --no-default-features
          cargo check -p meerkat-store --no-default-features
          cargo check -p meerkat-tools --no-default-features
          cargo check -p meerkat --no-default-features
          cargo nextest run -p meerkat-core

  test-feature-matrix-lib:
    name: Feature matrix (library)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: matrix-lib

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Library crate feature combinations
        run: |
          cargo check -p meerkat-tools --no-default-features --features sub-agents
          cargo check -p meerkat-tools --no-default-features --features comms
          cargo check -p meerkat-tools --no-default-features --features mcp
          cargo check -p meerkat-tools --no-default-features --features sub-agents,comms
          cargo check -p meerkat-tools --no-default-features --features comms,mcp
          cargo check -p meerkat --no-default-features --features openai,memory-store
          cargo check -p meerkat --no-default-features --features gemini,jsonl-store
          cargo check -p meerkat --features all-providers,comms,mcp,sub-agents
          cargo nextest run -p meerkat --features all-providers,comms,mcp

  test-feature-matrix-surface-checks:
    name: Feature matrix (surface checks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: matrix-surface-checks

      - name: Surface crate feature combinations
        run: |
          cargo check -p meerkat-rpc --no-default-features
          cargo check -p meerkat-rpc --no-default-features --features comms,mcp
          cargo check -p meerkat-rest --no-default-features
          cargo check -p meerkat-rest --no-default-features --features comms
          cargo check -p meerkat-mcp-server --no-default-features
          cargo check -p meerkat-mcp-server --no-default-features --features comms
          cargo check -p rkat --no-default-features --features session-store
          cargo check -p rkat --no-default-features --features session-store,mcp
          cargo check -p rkat --no-default-features --features session-store,comms,mcp

  test-surface-smoke:
    name: Surface smoke (${{ matrix.bin }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - pkg: rkat
            bin: rkat
            features: "--no-default-features --features session-store"
            test: true
          - pkg: meerkat-rpc
            bin: rkat-rpc
            features: "--no-default-features"
            test: false
          - pkg: meerkat-rest
            bin: rkat-rest
            features: "--no-default-features"
            test: false
          - pkg: meerkat-mcp-server
            bin: rkat-mcp
            features: "--no-default-features"
            test: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: smoke-${{ matrix.bin }}

      - name: Install nextest
        if: matrix.test
        uses: taiki-e/install-action@nextest

      - name: Build and smoke test
        run: cargo run -p ${{ matrix.pkg }} ${{ matrix.features }} --bin ${{ matrix.bin }} -- --help >/dev/null

      - name: Run tests
        if: matrix.test
        run: cargo nextest run -p ${{ matrix.pkg }} --no-default-features --features session-store,mcp --no-capture

  audit:
    name: Security audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run cargo-deny
        uses: EmbarkStudios/cargo-deny-action@v2

  gate:
    name: CI gate
    if: always()
    needs: [fmt-lint, test, test-minimal, test-feature-matrix-lib, test-feature-matrix-surface-checks, test-surface-smoke, audit]
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          failed=""
          for job in \
            fmt-lint \
            test \
            test-minimal \
            test-feature-matrix-lib \
            test-feature-matrix-surface-checks \
            test-surface-smoke \
            audit
          do
            case "$job" in
              fmt-lint) result="${{ needs.fmt-lint.result }}" ;;
              test) result="${{ needs.test.result }}" ;;
              test-minimal) result="${{ needs.test-minimal.result }}" ;;
              test-feature-matrix-lib) result="${{ needs.test-feature-matrix-lib.result }}" ;;
              test-feature-matrix-surface-checks) result="${{ needs.test-feature-matrix-surface-checks.result }}" ;;
              test-surface-smoke) result="${{ needs.test-surface-smoke.result }}" ;;
              audit) result="${{ needs.audit.result }}" ;;
            esac
            if [[ "$result" != "success" ]]; then
              echo "$job: $result"
              failed="true"
            fi
          done
          if [[ -n "$failed" ]]; then
            exit 1
          fi
          echo "All checks passed"
